version: '3.7'

services:
  lighthouse:
    image: petabridge/lighthouse:latest
    hostname: lighthouse
    ports:
      - '9110:9110'
      - '4053:4053'
    environment:
      ACTORSYSTEM: "Akka-Cluster"
      CLUSTER_PORT: 4053
      CLUSTER_IP: "lighthouse"
      CLUSTER_SEEDS: "akka.tcp://Akka-Cluster@lighthouse:4053"

  engine0:
    build:
      context: .
      dockerfile: ./Engine/Dockerfile
    ports:
      - '6000:9110'
    environment:
      CLUSTER_SEEDS: "akka.tcp://Akka-Cluster@lighthouse:4053"
      CLUSTER_PORT: 5110
    restart: on-failure
    depends_on:
      - "lighthouse"

  engine1:
    build:
      context: .
      dockerfile: ./Engine/Dockerfile
    ports:
      - '6001:9110'
    environment:
      CLUSTER_SEEDS: "akka.tcp://Akka-Cluster@lighthouse:4053"
      CLUSTER_PORT: 5110
    restart: on-failure
    depends_on:
      - "lighthouse"

  engine2:
    build:
      context: .
      dockerfile: ./Engine/Dockerfile
    ports:
      - '6002:9110'
    environment:
      CLUSTER_SEEDS: "akka.tcp://Akka-Cluster@lighthouse:4053"
      CLUSTER_PORT: 5110
    restart: on-failure
    depends_on:
      - "lighthouse"

  web0:
    build:
      context: .
      dockerfile: ./WebApp/Dockerfile
    ports:
      - "7000:9110"
      - "8080:80"
      - "8090:443"
    environment:
      CLUSTER_SEEDS: "akka.tcp://Akka-Cluster@lighthouse:4053"
      CLUSTER_PORT: 5110
    restart: on-failure
    depends_on:
      - "lighthouse"

  web1:
    build:
      context: .
      dockerfile: ./WebApp/Dockerfile
    ports:
      - "7001:9110"
      - "8081:80"
      - "8091:443"
    environment:
      CLUSTER_SEEDS: "akka.tcp://Akka-Cluster@lighthouse:4053"
      CLUSTER_PORT: 5110
    restart: on-failure
    depends_on:
      - "lighthouse"

  web2:
    build:
      context: .
      dockerfile: ./WebApp/Dockerfile
    ports:
      - "7002:9110"
      - "8082:80"
      - "8092:443"
    environment:
      CLUSTER_SEEDS: "akka.tcp://Akka-Cluster@lighthouse:4053"
      CLUSTER_PORT: 5110
    restart: on-failure
    depends_on:
      - "lighthouse"

  master:
    image: locustio/locust
    ports:
      - "8089:8089"
    volumes:
      - ./Build/locust/:/mnt/locust
    command: -f /mnt/locust/locustfile.py --master -H http://web0:8080 --logfile=locustfile.log

  worker:
    image: locustio/locust
    volumes:
      - ./Build/locust:/mnt/locust
    command: -f /mnt/locust/locustfile.py --worker --master-host master --logfile=locustfile.log
